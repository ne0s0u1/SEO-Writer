<!DOCTYPE html>
<html lang="zh">
<head>
<link rel="icon" type="image/svg+xml" href="./favicon.svg" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SEO æ–‡æ¡ˆç”Ÿæˆå·¥å…·</title>
<!-- å¼•å…¥å­—ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- å¼•å…¥ Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- å¼•å…¥ Icons (ä½¿ç”¨ Lucide å›¾æ ‡åº“) -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  /* æ»šåŠ¨æ¡ç¾åŒ– */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  
  body { font-family: 'Inter', sans-serif; }
  .lucide { vertical-align: middle; }

  /* æç®€å‘¼å¸èƒŒæ™¯ */
  @keyframes breathe {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 0.8; }
  }
  .animate-breathe { animation: breathe 8s ease-in-out infinite; }
  
  /* Section æ‹–æ‹½æ ·å¼ */
  .sortable-item { transition: all 0.2s ease-in-out; } 
  /* ç§»é™¤é»˜è®¤ grab å…‰æ ‡ï¼Œå› ä¸ºåªæœ‰æ‰‹æŸ„å¯æ‹– */
  .sortable-item:active { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transform: scale(1.02); }
  .sortable-drag { opacity: 0.5; }
  
  /* æ‰‹æŸ„æ ·å¼ */
  .drag-handle { cursor: grab; touch-action: none; }
  .drag-handle:active { cursor: grabbing; }

  /* éšè— number input ç®­å¤´ */
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { 
    -webkit-appearance: none; margin: 0; 
  }

  /* é”™è¯¯çŠ¶æ€æ ·å¼ */
  .input-error {
      border-color: #ef4444 !important; /* red-500 */
      box-shadow: 0 0 0 1px #ef4444 !important;
  }
  .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
  }
  @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
  }
</style>
</head>
<body class="bg-slate-50 min-h-screen p-3 md:p-8 relative text-slate-800 flex flex-col items-center overflow-x-hidden">

<!-- èƒŒæ™¯è£…é¥° -->
<div class="fixed inset-0 overflow-hidden pointer-events-none -z-10 bg-slate-50">
  <div class="absolute top-0 left-0 w-[70vw] h-[70vw] bg-[radial-gradient(circle_at_top_left,rgba(216,180,254,0.3)_0%,transparent_60%)] animate-breathe"></div>
  <div class="absolute bottom-0 right-0 w-[70vw] h-[70vw] bg-[radial-gradient(circle_at_bottom_right,rgba(191,219,254,0.3)_0%,transparent_60%)] animate-breathe" style="animation-delay: 4s;"></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[radial-gradient(circle,rgba(255,255,255,0.8)_0%,transparent_100%)]"></div>
</div>

<section class="container max-w-[95%] 2xl:max-w-[1600px] w-full transition-all duration-300">
  <div class="bg-white/70 rounded-[32px] border border-white/80 shadow-[0_4px_24px_rgba(0,0,0,0.02)] p-6 md:p-10 relative overflow-hidden ring-1 ring-white/60 min-h-[85vh] flex flex-col">
    
    <!-- æ ‡é¢˜åŒº (å·²ç®€åŒ–) -->
    <div class="flex flex-col items-center justify-center mb-6 border-b border-slate-200/60 pb-4 relative z-10">
      <div class="flex items-center gap-2">
        <i data-lucide="pen-tool" class="w-6 h-6 text-indigo-600 drop-shadow-sm"></i>
        <h1 class="text-xl font-bold text-slate-800 tracking-tight">SEOæ–‡æ¡ˆç”Ÿæˆå™¨</h1>
      </div>
    </div>

    <!-- ä¸»åŠŸèƒ½åŒºåŸŸ -->
    <div class="flex-1 flex flex-col lg:flex-row gap-8 relative z-10">
      <!-- å·¦ä¾§ï¼šè¾“å…¥æ§åˆ¶åŒº -->
      <div class="lg:w-2/5 xl:w-1/3 flex flex-col gap-6">
        <div class="bg-white/50 rounded-2xl p-6 border border-slate-200/50 shadow-lg flex flex-col gap-4 sticky top-0">
            
            <h2 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                <i data-lucide="settings-2" class="w-5 h-5 text-indigo-500"></i> è¾“å…¥ä¸é…ç½®
            </h2>

            <!-- 0. API Key Input -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">Gemini API Key (Worker)</label>
                <input id="geminiApiKey" type="password" placeholder="sk-..." class="w-full h-11 px-4 bg-white/80 border border-transparent rounded-xl text-slate-700 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-200 transition-all outline-none shadow-sm font-mono">
            </div>

            <!-- 1. æ ¸å¿ƒå…³é”®è¯ -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">æ ¸å¿ƒå…³é”®è¯ (Core Keyword)</label>
                <input id="coreKeyword" type="text" placeholder="ä¾‹å¦‚ï¼šAI Music Generator" class="w-full h-11 px-4 bg-white/80 border border-transparent rounded-xl text-slate-700 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-200 transition-all outline-none shadow-sm">
            </div>
            
            <!-- 2. æ¬¡è¦å…³é”®è¯ -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">æ¬¡è¦å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª)</label>
                <textarea id="secondaryKeywords" rows="5" placeholder="ä¾‹å¦‚ï¼š
Best AI Music Generator" class="w-full p-3 bg-white/80 border border-transparent rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-indigo-200 transition-all outline-none shadow-sm resize-y text-sm leading-relaxed"></textarea>
            </div>

            <!-- 3. å…³é”®è¯å¯†åº¦ & å“ç‰Œåç§° -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">å¯†åº¦ç›®æ ‡ (%)</label>
                    <input id="densityTarget" type="number" min="0.1" max="10" step="0.1" value="2" class="w-full h-11 px-4 text-center bg-white/80 border border-transparent rounded-xl text-slate-700 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-200 transition-all outline-none shadow-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">å“ç‰Œåç§°</label>
                    <input id="brandName" type="text" placeholder="ä¾‹å¦‚ï¼šMusicCreator" class="w-full h-11 px-4 bg-white/80 border border-transparent rounded-xl text-slate-700 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-200 transition-all outline-none shadow-sm">
                </div>
            </div>

            <!-- æ–°å¢ï¼šSEO Metadata é€‰é¡¹ -->
            <div class="bg-indigo-50/50 border border-indigo-100 p-3 rounded-xl flex items-center gap-3">
                <input type="checkbox" id="includeSeoMetadata" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                <label for="includeSeoMetadata" class="text-sm font-bold text-indigo-700 select-none cursor-pointer">
                    ç”Ÿæˆ SEO Metadata (Title, Description)
                </label>
            </div>

            <!-- 4 & 6. Section ç§ç±»ä¸é¡ºåº -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">æ‰€éœ€ Section ç§ç±»ä¸é¡ºåº (å¯æ‹–æ‹½)</label>
                <div id="sectionList" class="bg-white/80 rounded-xl border border-slate-200/50 p-3 flex flex-col gap-2">
                    <!-- Section Items will be populated here -->
                </div>
            </div>

            <!-- 7. è‡ªå®šä¹‰æç¤ºè¯ -->
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">è‡ªå®šä¹‰æç¤ºè¯ (å¯é€‰)</label>
                <textarea id="customPrompt" rows="3" placeholder="ä¾‹å¦‚ï¼šè¦æ±‚æ–‡æ¡ˆè¯­æ°”è½»æ¾æœ‰è¶£ï¼Œé¢å‘å¹´è½»è®¾è®¡å¸ˆç¾¤ä½“ã€‚" class="w-full p-3 bg-white/80 border border-transparent rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-indigo-200 transition-all outline-none shadow-sm resize-y text-sm"></textarea>
            </div>

            <!-- é”™è¯¯æç¤ºä¿¡æ¯ -->
            <div id="errorMsg" class="hidden text-red-500 text-xs font-bold text-center bg-red-50 p-2 rounded-lg border border-red-100"></div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="pt-2">
                <button id="generateBtn" class="w-full h-12 rounded-xl bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-base disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> ç”Ÿæˆ SEO æ–‡æ¡ˆ
                </button>
            </div>

            <!-- çŠ¶æ€æ  -->
            <div id="status" class="text-center text-sm font-medium text-slate-500 pt-1">
                è¯·å¡«å†™å¿…è¦ä¿¡æ¯å¹¶ç‚¹å‡»ç”Ÿæˆ
            </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šè¾“å‡ºåŒº -->
      <div class="lg:w-3/5 xl:w-2/3 flex flex-col gap-5">
         <div class="bg-white/50 rounded-2xl border border-white/60 shadow-inner p-6 flex flex-col min-h-[500px]">
            <div class="flex justify-between items-center mb-6 border-b border-slate-200/60 pb-3">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                   <div class="p-1.5 bg-emerald-100/80 rounded-lg text-emerald-700"><i data-lucide="file-text" class="w-4 h-4"></i></div>
                   æ–‡æ¡ˆç”Ÿæˆç»“æœ
                </h2>
                <div class="flex gap-2">
                    <button id="checkDensityBtn" class="px-4 py-2 rounded-full bg-yellow-500 text-white font-semibold text-sm shadow-md shadow-yellow-200 hover:bg-yellow-600 active:scale-[0.98] transition-all flex items-center gap-2 disabled:opacity-50" disabled>
                        <i data-lucide="tally-3" class="w-4 h-4"></i> æ£€æŸ¥å…³é”®è¯å¯†åº¦
                    </button>
                    <button id="copyAllBtn" class="px-4 py-2 rounded-full bg-slate-700 text-white font-semibold text-sm shadow-md shadow-slate-300 hover:bg-slate-800 active:scale-[0.98] transition-all flex items-center gap-2 disabled:opacity-50" disabled>
                        <i data-lucide="clipboard-copy" class="w-4 h-4"></i> å…¨éƒ¨å¤åˆ¶
                    </button>
                    <!-- æ–°å¢ï¼šè·³è½¬é…å›¾ç”Ÿæˆé¡µ -->
                    <button id="goToImageGenBtn" class="px-4 py-2 rounded-full bg-purple-500 text-white font-semibold text-sm shadow-md shadow-purple-200 hover:bg-purple-600 active:scale-[0.98] transition-all flex items-center gap-2 disabled:opacity-50" disabled>
                        <i data-lucide="image" class="w-4 h-4"></i> ç”Ÿæˆé…å›¾(å¼€å‘ä¸­)
                    </button>
                </div>
            </div>
         
            <!-- å…³é”®è¯å¯†åº¦ç»“æœå±•ç¤ºåŒº -->
            <div id="densityResult" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4 text-sm text-yellow-800"></div>

            <!-- æ–‡æ¡ˆè¾“å‡ºåŒº -->
            <div id="outputArea" class="flex flex-col gap-6 overflow-y-auto pr-2 custom-scroll flex-1 content-start">
                 <div class="flex flex-col items-center justify-center text-slate-400 h-64 gap-3">
                     <i data-lucide="layout-dashboard" class="w-10 h-10 opacity-50"></i>
                     <p class="text-sm">ç”Ÿæˆçš„æ–‡æ¡ˆå°†æŒ‰ Section é¡ºåºæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
                 </div>
            </div>
         </div>
      </div>
    </div>
  </div>
</section>

<footer class="relative z-10 text-center text-slate-400 text-xs font-medium py-6">
  Â© 2025 SEO Writer â€” Powered by Gemini
</footer>

<!-- å…¨å± Modal ç”¨äºåŠ è½½ Image Generator -->
<div id="imageGenModal" class="fixed inset-0 z-50 hidden">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeImageGenModal()"></div>
    
    <!-- Modal å†…å®¹ -->
    <div class="absolute inset-4 md:inset-10 bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden transform transition-all">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b border-slate-200 bg-white z-10">
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="image" class="w-5 h-5 text-purple-600"></i> 
                AI é…å›¾ç”Ÿæˆå™¨
            </h2>
            <button onclick="closeImageGenModal()" class="p-2 hover:bg-slate-100 rounded-full text-slate-500 hover:text-slate-700 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <!-- Iframe -->
        <div class="flex-1 bg-slate-50 relative">
            <iframe id="imageGenFrame" class="w-full h-full border-none" src=""></iframe>
            <!-- Loading Placeholder -->
            <div id="iframeLoader" class="absolute inset-0 flex items-center justify-center bg-white">
                <div class="flex flex-col items-center gap-2 text-slate-400">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-purple-500"></i>
                    <span class="text-sm">æ­£åœ¨åŠ è½½é…å›¾å·¥å…·...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
lucide.createIcons();

// =================================================================
// æ ¸å¿ƒé…ç½®ä¸çŠ¶æ€
// =================================================================
// **è¯·æ›¿æ¢ä¸ºæ‚¨éƒ¨ç½²çš„ Cloudflare Worker URL**
const WORKER_ENDPOINT = 'https://seo-writer.ne0s0u1-pd.workers.dev'; 

const SECTION_DEFAULTS = [
    { id: 'hero', label: 'Hero', active: false },
    { id: 'showcase', label: 'Showcase', active: true },
    { id: 'whyChooseUs', label: 'Why Choose Us', active: true, options: { count: 3, max: 9 }, icon: 'thumbs-up' },
    { id: 'howItWork', label: 'How it Work', active: true }, 
    { id: 'features', label: 'Features', active: true, options: { count: 4, max: 9 }, icon: 'layers-3' },
    { id: 'faq', label: 'FAQ', active: true, options: { count: 5, max: 9 }, icon: 'help-circle' },
    { id: 'cta', label: 'CTA', active: true },
    { id: 'howToUse', label: 'How to use', active: false },
    { id: 'whoCanBenefit', label: 'Who Can Benefit', active: false, options: { count: 3, max: 9 }, icon: 'users' },
];

let sectionStates = JSON.parse(JSON.stringify(SECTION_DEFAULTS));
let generatedCopy = null;

const el = {
    sectionList: document.getElementById('sectionList'),
    generateBtn: document.getElementById('generateBtn'),
    outputArea: document.getElementById('outputArea'),
    status: document.getElementById('status'),
    coreKeyword: document.getElementById('coreKeyword'),
    copyAllBtn: document.getElementById('copyAllBtn'),
    secondaryKeywords: document.getElementById('secondaryKeywords'),
    densityTarget: document.getElementById('densityTarget'),
    brandName: document.getElementById('brandName'),
    customPrompt: document.getElementById('customPrompt'),
    checkDensityBtn: document.getElementById('checkDensityBtn'),
    goToImageGenBtn: document.getElementById('goToImageGenBtn'), // æ–°å¢æŒ‰é’®
    densityResult: document.getElementById('densityResult'),
    geminiApiKey: document.getElementById('geminiApiKey'),
    includeSeoMetadata: document.getElementById('includeSeoMetadata'),
    errorMsg: document.getElementById('errorMsg'), // æ–°å¢é”™è¯¯æç¤ºåŒº
    // Modal ç›¸å…³
    imageGenModal: document.getElementById('imageGenModal'),
    imageGenFrame: document.getElementById('imageGenFrame'),
    iframeLoader: document.getElementById('iframeLoader'),
};

// API Key æŒä¹…åŒ–
el.geminiApiKey.value = localStorage.getItem("gemini_api_key") || "";
el.geminiApiKey.addEventListener("input", ()=>localStorage.setItem("gemini_api_key", el.geminiApiKey.value));

// =================================================================
// Section æ¸²æŸ“ä¸æ‹–æ‹½é€»è¾‘
// =================================================================
function renderSectionList() {
    el.sectionList.innerHTML = '';
    sectionStates.forEach(sec => {
        const item = document.createElement('div');
        item.className = 'sortable-item bg-white/70 p-3 rounded-lg border border-slate-100 shadow-sm';
        
        // é»˜è®¤ä¸å¯æ‹–åŠ¨ï¼Œåªæœ‰æŒ‰ä½æ‰‹æŸ„æ—¶æ‰å¼€å¯
        item.draggable = false; 
        
        item.dataset.id = sec.id;
        
        const hasOptions = sec.options;
        const count = hasOptions ? sec.options.count : 0;
        const max = hasOptions ? sec.options.max : 0;

        // **ä¿®æ”¹ç‚¹ 1**: å°† oninput æ‹†åˆ†ä¸º oninput (å®æ—¶å­˜æ•°æ®) å’Œ onblur (ç¦»ç„¦æ—¶æ ¡éªŒå¹¶ä¿®æ­£ UI)
        item.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 flex-1">
                    <!-- ç‹¬ç«‹çš„æ‹–æ‹½æ‰‹æŸ„ -->
                    <div class="drag-handle p-1.5 hover:bg-slate-100 rounded-md text-slate-400 transition-colors" title="æŒ‰ä½æ‹–åŠ¨æ’åº">
                        <i data-lucide="grip-vertical" class="w-4 h-4 pointer-events-none"></i>
                    </div>
                    <input type="checkbox" id="check-${sec.id}" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer" ${sec.active ? 'checked' : ''} onchange="toggleSection('${sec.id}', this.checked)">
                    <label for="check-${sec.id}" class="text-sm font-medium text-slate-700 select-none cursor-pointer flex-1">${sec.label}</label>
                </div>
                ${hasOptions ? `
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span class="font-medium text-slate-600">Count:</span>
                        <input type="number" min="1" max="${max}" value="${count}" 
                               class="w-12 h-6 px-1 text-center bg-white border border-slate-300 rounded-md text-slate-700 text-xs focus:ring-indigo-200 outline-none transition-all ${sec.active ? '' : 'opacity-50 cursor-not-allowed'}" 
                               oninput="updateOptionCount('${sec.id}', this.value, false)" 
                               onblur="updateOptionCount('${sec.id}', this.value, true)"
                               id="count-input-${sec.id}" ${sec.active ? '' : 'disabled'}>
                    </div>
                ` : ''}
            </div>
        `;
        el.sectionList.appendChild(item);
    });
    lucide.createIcons();
    addDragAndDropListeners();
}

function toggleSection(id, active) {
    const sec = sectionStates.find(s => s.id === id);
    if (sec) {
        sec.active = active;
        if (sec.options) {
            const inputEl = document.getElementById(`count-input-${id}`);
            if (inputEl) {
                inputEl.disabled = !active;
                inputEl.classList.toggle('opacity-50', !active);
                inputEl.classList.toggle('cursor-not-allowed', !active);
            }
        }
    }
}

// **ä¿®æ”¹ç‚¹ 2**: æ‹†åˆ†é€»è¾‘ï¼ŒisBlur=true æ—¶æ‰å¼ºåˆ¶æ›´æ–° DOM
function updateOptionCount(id, value, isBlur) {
    const sec = sectionStates.find(s => s.id === id);
    if (sec && sec.options) {
        // 1. æ›´æ–°æ•°æ®æ¨¡å‹ (å…è®¸ä¸´æ—¶éæ³•å€¼ï¼Œä¿è¯ç”¨æˆ·è¾“å…¥æµç•…)
        if (value !== "") {
            sec.options.count = parseInt(value);
        } else {
            // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œæš‚å­˜ä¸º 0 æˆ–ä¿æŒåŸå€¼ï¼Œç­‰å¾… blur ä¿®æ­£
            // è¿™é‡Œæš‚å­˜ä¸º 0ï¼Œæ–¹ä¾¿é€»è¾‘åˆ¤æ–­
            sec.options.count = 0;
        }

        // 2. åªæœ‰åœ¨å¤±å»ç„¦ç‚¹æ—¶ (isBlur=true) æ‰æ‰§è¡Œä¸¥æ ¼æ ¡éªŒå¹¶å¼ºåˆ¶å›å†™ DOM
        if (isBlur) {
            let count = parseInt(value);
            const max = sec.options.max;
            
            if (isNaN(count) || count < 1) count = 1;
            if (count > max) count = max;
            
            // æ›´æ–°æœ€ç»ˆçš„åˆæ³•æ•°æ®
            sec.options.count = count;
            
            // å¼ºåˆ¶æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
            const inputEl = document.getElementById(`count-input-${id}`);
            if (inputEl) {
                inputEl.value = count;
            }
        }
    }
}

function addDragAndDropListeners() {
    let dragSrcEl = null;

    function onHandleMouseDown(e) {
        const item = this.closest('.sortable-item');
        if (item) {
            item.draggable = true;
        }
    }

    function onHandleMouseUp(e) {
        const item = this.closest('.sortable-item');
        if (item) {
            item.draggable = false;
        }
    }

    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.id);
        this.classList.add('sortable-drag');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) { this.classList.add('ring-2', 'ring-indigo-300'); }
    function handleDragLeave(e) { this.classList.remove('ring-2', 'ring-indigo-300'); }

    function handleDrop(e) {
        e.stopPropagation();
        this.classList.remove('ring-2', 'ring-indigo-300');
        this.draggable = false;
        
        if (dragSrcEl !== this) {
            const dragId = dragSrcEl.dataset.id;
            const dropId = this.dataset.id;
            const dragIndex = sectionStates.findIndex(s => s.id === dragId);
            const dropIndex = sectionStates.findIndex(s => s.id === dropId);
            const [removed] = sectionStates.splice(dragIndex, 1);
            sectionStates.splice(dropIndex, 0, removed);
            renderSectionList();
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('sortable-drag');
        this.draggable = false;
        document.querySelectorAll('.sortable-item').forEach(item => item.classList.remove('ring-2', 'ring-indigo-300'));
    }

    document.querySelectorAll('.sortable-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);

        const handle = item.querySelector('.drag-handle');
        if (handle) {
            handle.addEventListener('mousedown', onHandleMouseDown);
            handle.addEventListener('mouseup', onHandleMouseUp);
            handle.addEventListener('mouseleave', onHandleMouseUp);
        }
    });
}

renderSectionList();

// =================================================================
// å…³é”®è¯å¯†åº¦è®¡ç®—
// =================================================================
function calculateKeywordDensity(allText, coreKeyword, secondaryKeywordsRaw, targetDensity) {
    const matches = allText.match(/[a-zA-Z0-9_\-]+|[\u4e00-\u9fa5]/g) || [];
    const totalWords = matches.length;
    
    const keywordList = [];
    if (coreKeyword.trim()) keywordList.push({ word: coreKeyword.trim(), type: 'core' });
    const secondaryList = secondaryKeywordsRaw.split('\n').map(k => k.trim()).filter(k => k.length > 0);
    secondaryList.forEach(k => keywordList.push({ word: k, type: 'secondary' }));

    const densityData = [];
    const lowerText = allText.toLowerCase();

    keywordList.forEach(item => {
        const word = item.word;
        const lowerWord = word.toLowerCase();
        let count = 0;
        let pos = 0;
        while (true) {
            const foundPos = lowerText.indexOf(lowerWord, pos);
            if (foundPos === -1) break;
            count++;
            pos = foundPos + 1;
        }
        
        const density = totalWords > 0 ? ((count / totalWords) * 100).toFixed(2) : 0;
        let status = 'åˆé€‚';
        if (item.type === 'core') {
             if (density < targetDensity - 0.5) status = 'åä½';
             else if (density > targetDensity + 0.5) status = 'åé«˜';
        } else {
             if (density > 0) status = 'å·²è¦†ç›–';
             else status = 'æœªå‡ºç°';
        }

        densityData.push({
            keyword: word,
            type: item.type === 'core' ? 'æ ¸å¿ƒ' : 'æ¬¡è¦',
            count: count,
            density: density,
            status: status
        });
    });

    return { totalWords, densityData };
}

function displayDensityResult(allText) {
    const coreKeyword = el.coreKeyword.value;
    const secondaryKeywordsRaw = el.secondaryKeywords.value;
    const targetDensity = parseFloat(el.densityTarget.value) || 2.0;

    if (!coreKeyword && !secondaryKeywordsRaw.trim()) {
        el.densityResult.innerHTML = `<p class="text-red-500">è¯·å…ˆè¾“å…¥æ ¸å¿ƒå…³é”®è¯æˆ–æ¬¡è¦å…³é”®è¯ã€‚</p>`;
        el.densityResult.classList.remove('hidden');
        return;
    }
    
    const result = calculateKeywordDensity(allText, coreKeyword, secondaryKeywordsRaw, targetDensity);

    let html = `
        <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
            <i data-lucide="bar-chart-2" class="w-4 h-4 text-indigo-600"></i> 
            å…³é”®è¯å¯†åº¦æ£€æŸ¥æŠ¥å‘Š
        </h3>
        <div class="mb-3 text-xs text-slate-500 bg-slate-100 p-2 rounded">
            ç»Ÿè®¡è§„åˆ™ï¼šè‹±æ–‡å•è¯ä»¥ç©ºæ ¼åˆ†éš”ï¼Œä¸­æ–‡æŒ‰å­—æ•°ç»Ÿè®¡ï¼Œå·²æ’é™¤æ ‡ç‚¹ç¬¦å·ã€‚<br>
            è®¡ç®—å…¬å¼ï¼š(å…³é”®è¯å‡ºç°æ¬¡æ•° / æ–‡ç« æ€»è¯æ•°) * 100%
        </div>
        <p class="text-sm mb-3">
            æ–‡æ¡ˆæ€»è¯æ•°: <strong class="text-indigo-700">${result.totalWords}</strong>
        </p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-slate-600">
                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                    <tr>
                        <th class="px-3 py-2 rounded-l-lg">ç±»å‹</th>
                        <th class="px-3 py-2">å…³é”®è¯</th>
                        <th class="px-3 py-2 text-center">æ¬¡æ•°</th>
                        <th class="px-3 py-2 text-center">å¯†åº¦</th>
                        <th class="px-3 py-2 rounded-r-lg text-right">çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
    `;

    result.densityData.forEach(data => {
        const statusColor = data.status === 'åˆé€‚' || data.status === 'å·²è¦†ç›–' ? 'text-green-600' : data.status === 'æœªå‡ºç°' ? 'text-slate-400' : 'text-orange-500';
        const typeBadge = data.type === 'æ ¸å¿ƒ' ? '<span class="px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-700 text-[10px] font-bold">CORE</span>' : '<span class="px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 text-[10px]">SEC</span>';
        html += `
            <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-3 py-2">${typeBadge}</td>
                <td class="px-3 py-2 font-medium text-slate-800">${data.keyword}</td>
                <td class="px-3 py-2 text-center font-mono">${data.count}</td>
                <td class="px-3 py-2 text-center font-mono">${data.density}%</td>
                <td class="px-3 py-2 text-right font-bold ${statusColor}">${data.status}</td>
            </tr>
        `;
    });
    html += `</tbody></table></div>`;
    el.densityResult.innerHTML = html;
    el.densityResult.classList.remove('hidden');
    lucide.createIcons();
}

// =================================================================
// Worker Payload & Interaction
// =================================================================
// è¾…åŠ©å‡½æ•°ï¼šæ¸…é™¤é”™è¯¯æ ·å¼
function clearErrors() {
    const inputs = [el.geminiApiKey, el.coreKeyword, el.brandName]; // æ¬¡è¦å…³é”®è¯éå¿…é¡»
    inputs.forEach(input => input.classList.remove('input-error', 'shake'));
    el.errorMsg.classList.add('hidden');
    el.errorMsg.textContent = '';
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯
function showError(inputEl, message) {
    inputEl.classList.add('input-error', 'shake');
    // ç§»é™¤ shake åŠ¨ç”»ç±»ä»¥ä¾¿ä¸‹æ¬¡è§¦å‘
    setTimeout(() => inputEl.classList.remove('shake'), 500);
    
    el.errorMsg.textContent = `âŒ ${message}`;
    el.errorMsg.classList.remove('hidden');
}

function getWorkerPayload(rewriteSectionId = null, customRewritePrompt = null) {
    clearErrors();

    const coreKeyword = el.coreKeyword.value.trim();
    const secondaryKeywordsRaw = el.secondaryKeywords.value.trim();
    const secondaryKeywords = secondaryKeywordsRaw.replace(/\n/g, ', ');
    const brandName = el.brandName.value.trim();
    let customPrompt = el.customPrompt.value.trim();
    const densityTarget = parseFloat(el.densityTarget.value) || 2.0;
    const apiKey = el.geminiApiKey.value.trim();
    const includeMetadata = el.includeSeoMetadata.checked; 

    // æ ¡éªŒé€»è¾‘
    if (!apiKey) {
        showError(el.geminiApiKey, "è¯·è¾“å…¥ API Key");
        el.geminiApiKey.focus();
        return null;
    }
    if (!coreKeyword) {
        showError(el.coreKeyword, "è¯·è¾“å…¥æ ¸å¿ƒå…³é”®è¯");
        el.coreKeyword.focus();
        return null;
    }
    if (!brandName) {
        showError(el.brandName, "è¯·è¾“å…¥å“ç‰Œåç§°");
        el.brandName.focus();
        return null;
    }

    let sectionsConfig = [];
    
    if (rewriteSectionId) {
        // **é‡å†™æ¨¡å¼**
        const sec = sectionStates.find(s => s.id === rewriteSectionId) || (rewriteSectionId === 'seo_metadata' ? { id: 'seo_metadata', label: 'SEO Metadata' } : null);
        
        if (!sec) {
            console.error("æ‰¾ä¸åˆ°è¦é‡å†™çš„ Section:", rewriteSectionId);
            return null;
        }
        
        sectionsConfig = [{
            id: sec.id,
            label: sec.label,
            options: sec.options // ä¼ é€’ options ä»¥ä¾¿åç«¯è·å– count
        }];
        
        if (customRewritePrompt) {
            customPrompt = `ã€é‡å†™æŒ‡ä»¤ã€‘é’ˆå¯¹ ${sec.label} è¿›è¡Œä¿®æ”¹ï¼š${customRewritePrompt}ã€‚` + (customPrompt ? ` (åŸæœ‰è¦æ±‚ï¼š${customPrompt})` : '');
        }
        
        if (rewriteSectionId === 'seo_metadata') {
             sectionsConfig = [{ id: 'seo_metadata', label: 'SEO Metadata', count: 0 }];
        } 

    } else {
        // **æ­£å¸¸ç”Ÿæˆæ¨¡å¼**
        const activeSections = sectionStates.filter(s => s.active);
        if (activeSections.length === 0) {
            el.errorMsg.textContent = "âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ª Sectionï¼";
            el.errorMsg.classList.remove('hidden');
            return null;
        }
        
        sectionsConfig = activeSections.map(sec => ({
            id: sec.id,
            label: sec.label,
            options: sec.options 
        }));
    }

    return {
        coreKeyword, secondaryKeywords, brandName, densityTarget,
        customPrompt, sections: sectionsConfig, apiKey, 
        includeMetadata: rewriteSectionId ? false : includeMetadata 
    };
}

async function runGenerator() {
    const payload = getWorkerPayload();
    if (!payload) return;

    el.generateBtn.disabled = true;
    el.generateBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> æ–‡æ¡ˆç”Ÿæˆä¸­...`;
    el.status.textContent = '...';
    el.outputArea.innerHTML = '';
    el.densityResult.classList.add('hidden');
    el.checkDensityBtn.disabled = true;
    generatedCopy = null;

    try {
        const res = await fetch(WORKER_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload) 
        });

        if (!res.ok) {
             const errorBody = await res.text().catch(() => 'No response body');
             throw new Error(`Worker è¿”å›é”™è¯¯ï¼çŠ¶æ€ç : ${res.status}. è¯¦æƒ…: ${errorBody.substring(0, 100)}`);
        }

        const response = await res.json();
        if (response.error) throw new Error(response.error);

        generatedCopy = response;
        renderCopyOutput(response);

        const allText = Object.entries(response)
            .filter(([key, value]) => key !== 'seo_metadata')
            .map(([key, value]) => value)
            .join('\n\n');

        el.checkDensityBtn.disabled = false;
        el.goToImageGenBtn.disabled = false; // å¯ç”¨é…å›¾æŒ‰é’®
        el.copyAllBtn.disabled = false; 
        el.copyAllBtn.onclick = copyAllContent;
        el.checkDensityBtn.onclick = () => displayDensityResult(allText);
        el.status.textContent = 'âœ… æ–‡æ¡ˆç”ŸæˆæˆåŠŸï¼è¯·æ£€æŸ¥å³ä¾§ç»“æœã€‚';

    } catch (e) {
        console.error("Worker äº¤äº’é”™è¯¯:", e);
        el.status.textContent = `âŒ æ–‡æ¡ˆç”Ÿæˆå¤±è´¥ï¼š${e.message}`;
    } finally {
        el.generateBtn.disabled = false;
        el.generateBtn.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5"></i> ç”Ÿæˆ SEO æ–‡æ¡ˆ`;
        lucide.createIcons();
    }
}

// **æ–°å¢ï¼šé‡å†™ Section é€»è¾‘**
async function rewriteSection(sectionId, promptInputId, cardId) {
    const promptInput = document.getElementById(promptInputId);
    const customRewritePrompt = promptInput.value.trim();
    
    if (!customRewritePrompt) {
        alert("è¯·è¾“å…¥ä¿®æ”¹è¦æ±‚ï¼");
        return;
    }
    
    const cardEl = document.getElementById(cardId);
    const contentContainer = cardEl.querySelector('.prose');
    const originalContent = contentContainer.innerHTML; // å¤‡ä»½ï¼Œä»¥ä¾¿å¤±è´¥æ¢å¤ï¼ˆå¯é€‰ï¼‰

    // UI Loading çŠ¶æ€
    contentContainer.innerHTML = `<div class="flex items-center gap-2 text-indigo-600 py-4"><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> æ­£åœ¨é‡å†™...</div>`;
    lucide.createIcons();

    // è·å– Payload (ä»…é’ˆå¯¹è¯¥ Section)
    const payload = getWorkerPayload(sectionId, customRewritePrompt);
    if (!payload) {
        contentContainer.innerHTML = originalContent; // æ¢å¤
        return;
    }

    try {
        const res = await fetch(WORKER_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload) 
        });

        if (!res.ok) throw new Error(`Worker error: ${res.status}`);
        
        const response = await res.json();
        if (response.error) throw new Error(response.error);

        // è·å–æ–°å†…å®¹ (Worker ç°åœ¨ç›´æ¥è¿”å› { [sectionId]: "..." })
        let newContent = response[sectionId];
        
        if (!newContent) {
             throw new Error("é‡å†™è¿”å›å†…å®¹ä¸ºç©º");
        }

        // æ›´æ–°å…¨å±€æ•°æ® generatedCopy
        if (generatedCopy) {
            generatedCopy[sectionId] = newContent;
        } else {
            generatedCopy = { [sectionId]: newContent };
        }

        // æ›´æ–° UI
        contentContainer.innerHTML = marked.parse(newContent);
        
        // æ›´æ–°éšè—çš„ Textarea ç”¨äºå¤åˆ¶
        const copyTextarea = cardEl.querySelector('textarea.hidden');
        if (copyTextarea) copyTextarea.value = newContent;

        // å…³é—­è¾“å…¥æ¡†
        toggleRewriteInput(cardId + '-rewrite-box');

    } catch (e) {
        console.error("Rewrite error:", e);
        alert(`é‡å†™å¤±è´¥: ${e.message}`);
        contentContainer.innerHTML = originalContent; // æ¢å¤
    }
}

function toggleRewriteInput(elementId) {
    const el = document.getElementById(elementId);
    if (el) {
        el.classList.toggle('hidden');
        // è‡ªåŠ¨èšç„¦
        if (!el.classList.contains('hidden')) {
            const input = el.querySelector('textarea');
            if(input) input.focus();
        }
    }
}

// **ä¿®æ”¹ç‚¹ï¼šæ·»åŠ å¤åˆ¶æŒ‰é’®å’Œé€»è¾‘**
function renderCopyOutput(copyData) {
    el.outputArea.innerHTML = '';
    
    // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå¡ç‰‡å†…å®¹
    const createCard = (id, title, content, icon, isMeta = false) => {
        const card = document.createElement('div');
        const borderClass = isMeta 
            ? 'bg-indigo-50/50 border border-indigo-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-all border-l-4 border-l-indigo-500'
            : 'bg-white/70 border border-slate-200 rounded-xl p-5 shadow-lg hover:shadow-xl transition-all';
        
        const titleColor = isMeta ? 'text-indigo-700' : 'text-indigo-700';
        const iconEl = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;

        // å”¯ä¸€ID
        const uniqueId = Math.random().toString(36).substr(2, 9);
        const contentId = `content-${uniqueId}`;
        const cardId = `card-${uniqueId}`;
        const rewriteBoxId = `${cardId}-rewrite-box`;
        const promptInputId = `${cardId}-prompt-input`;

        card.id = cardId;
        card.className = borderClass;
        card.innerHTML = `
            <div class="flex justify-between items-center mb-3 border-b pb-2 border-indigo-100/50">
                <h3 class="text-lg font-bold ${titleColor} flex items-center gap-2">
                    ${iconEl} ${title}
                </h3>
                <div class="flex gap-2">
                    <button onclick="toggleRewriteInput('${rewriteBoxId}')" class="text-xs bg-white hover:bg-indigo-50 border border-slate-200 text-slate-600 px-2 py-1 rounded transition-colors flex items-center gap-1" title="é‡å†™æ­¤éƒ¨åˆ†">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> é‡å†™
                    </button>
                    <button onclick="copyText('${contentId}', this)" class="text-xs bg-white hover:bg-indigo-50 border border-slate-200 text-slate-600 px-2 py-1 rounded transition-colors flex items-center gap-1" title="å¤åˆ¶å†…å®¹">
                        <i data-lucide="copy" class="w-3 h-3"></i> å¤åˆ¶
                    </button>
                </div>
            </div>
            
            <!-- é‡å†™è¾“å…¥æ¡† (é»˜è®¤éšè—) -->
            <div id="${rewriteBoxId}" class="hidden mb-4 bg-slate-50 p-3 rounded-lg border border-indigo-100">
                <label class="block text-xs font-bold text-slate-500 mb-1">ä¿®æ”¹è¦æ±‚ (å¯é€‰):</label>
                <textarea id="${promptInputId}" class="w-full p-2 text-sm border border-slate-300 rounded mb-2 focus:ring-2 focus:ring-indigo-200 outline-none" rows="2" placeholder="ä¾‹å¦‚ï¼šè¯­æ°”æ›´ä¸“ä¸šä¸€ç‚¹ï¼Œæˆ–è€…å¢åŠ æ›´å¤šç»†èŠ‚..."></textarea>
                <div class="flex justify-end gap-2">
                    <button onclick="toggleRewriteInput('${rewriteBoxId}')" class="text-xs text-slate-500 hover:text-slate-700 px-3 py-1">å–æ¶ˆ</button>
                    <button onclick="rewriteSection('${id}', '${promptInputId}', '${cardId}')" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition-colors flex items-center gap-1">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> ç¡®è®¤é‡å†™
                    </button>
                </div>
            </div>

            <div class="prose max-w-none text-slate-800 text-sm leading-relaxed">
                ${marked.parse(content)}
            </div>
            <!-- éšè—çš„æ–‡æœ¬åŸŸç”¨äºå¤åˆ¶åŸå§‹å†…å®¹ -->
            <textarea id="${contentId}" class="hidden">${content}</textarea>
        `;
        return card;
    };

    // ä¼˜å…ˆæ¸²æŸ“ SEO Metadata
    if (copyData['seo_metadata']) {
        let metaContentRaw = copyData['seo_metadata'];
        if (typeof metaContentRaw === 'object' && metaContentRaw !== null) {
             metaContentRaw = "```json\n" + JSON.stringify(metaContentRaw, null, 2) + "\n```";
        }
        const metaContent = String(metaContentRaw || "");
        el.outputArea.appendChild(createCard('seo_metadata', 'SEO Metadata', metaContent, 'search', true));
    }

    // æ¸²æŸ“å…¶ä»– Section
    sectionStates.filter(s => s.active).forEach(sec => {
        let contentRaw = copyData[sec.id];
        if (typeof contentRaw === 'object' && contentRaw !== null) {
             contentRaw = "```json\n" + JSON.stringify(contentRaw, null, 2) + "\n```";
        }
        const content = String(contentRaw || 'ã€æ–‡æ¡ˆç¼ºå¤±æˆ–ç”Ÿæˆå¤±è´¥ã€‘');
        el.outputArea.appendChild(createCard(sec.id, sec.label, content, getSectionIcon(sec.id)));
    });
    lucide.createIcons();
}

// **æ–°å¢ï¼šå…¨å±€å¤åˆ¶å‡½æ•°**
window.copyText = function(elementId, btn) {
    const text = document.getElementById(elementId).value;
    
    // ä½¿ç”¨ Clipboard API æˆ– fallback
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showCopySuccess(btn));
    } else {
        // Fallback for older browsers or http
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        showCopySuccess(btn);
    }
};

function showCopySuccess(btn) {
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> å·²å¤åˆ¶`;
    btn.classList.add('text-green-600', 'border-green-200', 'bg-green-50');
    lucide.createIcons();
    
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.remove('text-green-600', 'border-green-200', 'bg-green-50');
        lucide.createIcons();
    }, 2000);
}

function getSectionIcon(id) {
    switch (id) {
        case 'hero': return 'star';
        case 'showcase': return 'award';
        case 'howItWork':
        case 'howToUse': return 'sliders';
        case 'features': return 'layers-3';
        case 'whyChooseUs': return 'thumbs-up';
        case 'whoCanBenefit': return 'users';
        case 'faq': return 'help-circle';
        case 'cta': return 'mouse-pointer-click';
        default: return 'bookmark';
    }
}

el.generateBtn.addEventListener('click', runGenerator);

const markedScript = document.createElement('script');
markedScript.src = 'https://cdn.jsdelivr.net/npm/marked@13.0.0/marked.min.js';
markedScript.onload = () => {
    marked.setOptions({ gfm: true, breaks: true, sanitize: true });
};
document.head.appendChild(markedScript);

// è·³è½¬å›¾ç‰‡ç”Ÿæˆé¡µ
el.goToImageGenBtn.addEventListener('click', () => {
    // å°†ç”Ÿæˆçš„æ•°æ®ä¿å­˜åˆ° localStorage
    localStorage.setItem('seo_generated_copy', JSON.stringify(generatedCopy));
    localStorage.setItem('seo_section_states', JSON.stringify(sectionStates)); // ç”¨äºçŸ¥é“æœ‰å“ªäº›Section
    
    // æ‰“å¼€ Modal
    el.imageGenFrame.src = 'image_generator.html';
    el.imageGenModal.classList.remove('hidden');
    
    // ç›‘å¬ iframe åŠ è½½å®Œæˆ
    el.imageGenFrame.onload = () => {
        el.iframeLoader.classList.add('hidden');
    };
});

// å…³é—­ Modal
window.closeImageGenModal = function() {
    el.imageGenModal.classList.add('hidden');
    el.imageGenFrame.src = ''; // æ¸…ç©º src
    el.iframeLoader.classList.remove('hidden'); // é‡ç½® loader
};

el.checkDensityBtn.addEventListener('click', () => {
    if (!generatedCopy) {
        alert('è¯·å…ˆç”Ÿæˆæ–‡æ¡ˆï¼');
        return;
    }
    const allText = Object.entries(generatedCopy)
        .filter(([key, value]) => key !== 'seo_metadata')
        .map(([key, value]) => value)
        .join('\n\n');
    displayDensityResult(allText);
});

/**
 * éå†æ‰€æœ‰ç”Ÿæˆçš„æ–‡æ¡ˆï¼Œè¿åŒ Section æ ‡é¢˜ä¸€èµ·æ ¼å¼åŒ–åå¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚
 */
function copyAllContent() {
    if (!generatedCopy) {
        alert("è¯·å…ˆç”Ÿæˆæ–‡æ¡ˆï¼");
        return;
    }

    let fullText = "";

    // éå† sectionStates ä»¥ä¿æŒæ­£ç¡®çš„é¡ºåº
    sectionStates.filter(s => s.active).forEach(sec => {
        const content = generatedCopy[sec.id];
        
        if (content) {
            fullText += `\n\n## ${sec.label} Section\n\n`;
            let contentString = String(content);
            if (contentString === '[object Object]') {
                contentString = JSON.stringify(content, null, 2);
            }
            fullText += contentString;
        }
    });

    if (fullText.trim().length === 0) {
        alert("æ–‡æ¡ˆå†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶ã€‚");
        return;
    }
    
    // ğŸ”¥ ç»Ÿä¸€ä½¿ç”¨ Fallback æœºåˆ¶ï¼šåˆ›å»ºéšè—çš„ Textarea å¹¶æ‰§è¡Œ copy
    const textArea = document.createElement("textarea");
    textArea.value = fullText.trim();
    // éšè—å…ƒç´ ï¼Œä½†å¿…é¡»åœ¨ DOM ä¸­
    textArea.style.position = 'fixed';
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.opacity = '0'; 

    document.body.appendChild(textArea);
    textArea.select();
    
    // æ‰§è¡Œå¤åˆ¶æ“ä½œ (è¿™æ˜¯æ‚¨ç¯å¢ƒä¸­å·²çŸ¥æœ‰æ•ˆçš„æ–¹æ³•)
    document.execCommand("copy");
    
    document.body.removeChild(textArea);
    
    // æç¤ºç”¨æˆ·å¤åˆ¶æˆåŠŸ
    const btn = document.getElementById('copyAllBtn');
    showCopySuccess(btn); 
}
</script>
</body>
</html>








